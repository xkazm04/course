# PR Evaluator - Claude Code Command Template

Evaluate pull request submissions for a homework assignment, provide detailed feedback, and select the winning submission.

## Variables

- `$PROJECT_ID` - UUID of the project
- `$HOMEWORK_ID` - UUID of the homework definition
- `$GITHUB_TOKEN` - GitHub personal access token for API calls
- `$API_BASE_URL` - Base URL for API calls (default: http://localhost:3000)

---

## Instructions

You are a senior software engineer conducting thorough code reviews for student submissions. Your task is to evaluate all PR submissions for a specific homework assignment, provide actionable feedback, and select the best submission.

### Step 1: Fetch Homework Details

First, get the homework definition and acceptance criteria:

```bash
# Fetch homework details including acceptance criteria
curl "$API_BASE_URL/api/projects/homework-definitions/$HOMEWORK_ID"
```

This returns:
- `name`, `slug`, `description`
- `acceptance_criteria` - Array of criteria with weights
- `file_scope` - Expected files to be modified
- `branch_prefix` - Expected branch pattern
- Repository info (`owner`, `name`, `default_branch`)

### Step 2: List All Submissions

Query GitHub API for PRs matching the branch naming convention:

```
feat/<feature-slug>:<homework-slug>:<username>
```

```bash
# Using GitHub CLI
gh pr list --repo $REPO_OWNER/$REPO_NAME \
  --search "head:$BRANCH_PREFIX" \
  --state all \
  --json number,title,author,headRefName,url,createdAt,additions,deletions,files

# Or using curl
curl -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "Accept: application/vnd.github.v3+json" \
  "https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/pulls?head=$BRANCH_PREFIX&state=all"
```

For each PR, also fetch:
- Changed files: `GET /repos/{owner}/{repo}/pulls/{number}/files`
- Full diff for review

### Step 3: Review Each PR

For each PR submission, perform a comprehensive evaluation across three categories:

#### 3.1 Code Quality Assessment (40 points max)

| Criterion | Points | Description |
|-----------|--------|-------------|
| Correctness | 15 | Does the code work as intended? |
| Clean Code | 10 | Readable, well-named, properly formatted |
| Type Safety | 5 | Proper TypeScript usage, no `any` types |
| Error Handling | 5 | Graceful error handling, edge cases |
| No Anti-patterns | 5 | Avoids common pitfalls, follows best practices |

**Review Process:**
1. Read through each changed file
2. Check for logical errors
3. Evaluate naming conventions and code organization
4. Look for proper error boundaries and try/catch blocks
5. Identify any code smells or anti-patterns

#### 3.2 Acceptance Criteria Assessment (40 points max)

For each criterion from the homework definition:
- **Met** (100%): Criterion fully satisfied
- **Partial** (50%): Criterion partially implemented
- **Not Met** (0%): Criterion not addressed

Document specific evidence for each criterion:
- File and line number where implementation exists
- Test results or visual verification
- Missing elements if partial/not met

#### 3.3 Excellence Factors (20 points max)

| Factor | Points | Description |
|--------|--------|-------------|
| Beyond Requirements | 5 | Valuable additions beyond spec |
| Code Organization | 5 | Excellent file/folder structure |
| Documentation | 5 | Helpful comments, README updates |
| Test Coverage | 5 | Meaningful tests included |

### Step 4: Generate Feedback Comment

For each PR, create a detailed GitHub comment using this template:

```markdown
## Homework Submission Review

### Summary
[2-3 sentence overall assessment of the submission]

### Acceptance Criteria Evaluation

| # | Criterion | Status | Notes |
|---|-----------|--------|-------|
| 1 | [Description] | :white_check_mark: | [Specific feedback] |
| 2 | [Description] | :warning: Partial | [What's missing] |
| 3 | [Description] | :x: Not Met | [What's needed] |

### Code Quality Assessment

**Score: X/40**

**Strengths:**
- [Specific positive with file:line reference]
- [Another strength]
- [Third strength if applicable]

**Areas for Improvement:**
- [Specific constructive feedback with example]
- [Another improvement with suggested approach]
- [Third improvement if applicable]

### Excellence Factors

**Score: X/20**

| Factor | Score | Notes |
|--------|-------|-------|
| Beyond Requirements | X/5 | [Feedback] |
| Code Organization | X/5 | [Feedback] |
| Documentation | X/5 | [Feedback] |
| Test Coverage | X/5 | [Feedback] |

### Final Score: **X/100**

### Recommendations for Improvement
1. [Most important improvement with example]
2. [Second priority improvement]
3. [Third priority if applicable]

### What You Did Well
[Highlight 1-2 things this student did particularly well to encourage them]

---
*This review was generated by the AI Learning Conductor.*
*Questions? Reach out to your mentor or post in the discussion forum.*
```

### Step 5: Select Winner

After reviewing all submissions, select the winner based on:

1. **Primary**: Highest total score
2. **Tie-breaker 1**: Best code quality score
3. **Tie-breaker 2**: Best acceptance criteria score
4. **Tie-breaker 3**: Earlier submission time

**Winner Selection Criteria:**
- Must have score >= 60/100 to be eligible
- All acceptance criteria must be at least partially met
- No critical bugs or security issues

### Step 6: Post Results

For each PR:
1. Post the feedback comment
2. For the winner, add a special winner comment:

```markdown
## :trophy: Winner Selected!

Congratulations! Your submission has been selected as the best implementation for this homework assignment.

**Final Score: X/100**

### Why This Submission Won
[Specific reasons why this was the best submission]

### What Made It Stand Out
- [Specific excellence factor]
- [Another standout aspect]

Your solution will be featured as a reference implementation. Great work!
```

3. Add label `winner` to the winning PR

---

## Output Format

Generate a JSON report:

```json
{
  "homework_id": "$HOMEWORK_ID",
  "project_id": "$PROJECT_ID",
  "evaluation_timestamp": "2025-01-15T14:30:00Z",
  "homework_name": "Core Authentication Implementation",
  "repository": {
    "owner": "org-name",
    "name": "project-repo",
    "default_branch": "main"
  },

  "total_submissions": 5,
  "eligible_submissions": 4,
  "disqualified_submissions": 1,

  "evaluations": [
    {
      "pr_number": 42,
      "pr_url": "https://github.com/owner/repo/pull/42",
      "author": "student_username",
      "branch": "feat/user-authentication:auth-provider-implementation:student_username",
      "submitted_at": "2025-01-14T10:00:00Z",

      "files_changed": [
        "src/lib/auth/AuthProvider.tsx",
        "src/lib/auth/useAuth.ts",
        "src/middleware.ts"
      ],
      "additions": 245,
      "deletions": 12,

      "scores": {
        "code_quality": {
          "correctness": 14,
          "clean_code": 8,
          "type_safety": 5,
          "error_handling": 4,
          "no_antipatterns": 5,
          "total": 36,
          "max": 40
        },
        "acceptance_criteria": {
          "ac-1": {
            "status": "met",
            "score": 20,
            "max": 20,
            "evidence": "AuthProvider correctly wraps app in _app.tsx",
            "notes": "Clean implementation"
          },
          "ac-2": {
            "status": "met",
            "score": 25,
            "max": 25,
            "evidence": "Login function in useAuth.ts line 45",
            "notes": "Handles async properly"
          },
          "ac-3": {
            "status": "partial",
            "score": 12,
            "max": 25,
            "evidence": "Token stored but not validated on refresh",
            "notes": "Missing token validation on mount"
          },
          "ac-4": {
            "status": "met",
            "score": 20,
            "max": 20,
            "evidence": "Logout clears localStorage and state",
            "notes": "Complete implementation"
          },
          "ac-5": {
            "status": "met",
            "score": 10,
            "max": 10,
            "evidence": "isLoading state properly managed",
            "notes": "Good UX"
          },
          "total": 87,
          "max": 100,
          "weighted_total": 35,
          "weighted_max": 40
        },
        "excellence": {
          "beyond_requirements": 3,
          "code_organization": 4,
          "documentation": 2,
          "test_coverage": 0,
          "total": 9,
          "max": 20
        },
        "final_score": 80,
        "max_score": 100
      },

      "feedback_comment": "## Homework Submission Review\n\n...[full markdown]...",

      "strengths": [
        "Clean Context implementation with proper TypeScript types",
        "Good separation of concerns between provider and hook",
        "Proper async handling in login function"
      ],

      "improvements": [
        "Add token refresh/validation on app mount",
        "Consider adding loading state UI feedback",
        "Add unit tests for auth logic"
      ],

      "eligible": true,
      "disqualification_reason": null
    },
    {
      "pr_number": 38,
      "author": "another_student",
      "eligible": false,
      "disqualification_reason": "Score below 60 threshold (45/100)",
      "scores": {
        "final_score": 45
      }
    }
  ],

  "winner": {
    "pr_number": 42,
    "author": "student_username",
    "pr_url": "https://github.com/owner/repo/pull/42",
    "final_score": 80,
    "selection_reason": "Highest overall score with excellent code quality and clean architecture"
  },

  "runner_ups": [
    {
      "position": 2,
      "pr_number": 45,
      "author": "second_place",
      "final_score": 76
    },
    {
      "position": 3,
      "pr_number": 41,
      "author": "third_place",
      "final_score": 72
    }
  ],

  "actions_taken": [
    {
      "action": "comment_posted",
      "pr_number": 42,
      "comment_id": "IC_kwDOA...",
      "comment_url": "https://github.com/owner/repo/pull/42#issuecomment-..."
    },
    {
      "action": "comment_posted",
      "pr_number": 45,
      "comment_id": "IC_kwDOB...",
      "comment_url": "..."
    },
    {
      "action": "winner_comment_posted",
      "pr_number": 42,
      "comment_id": "IC_kwDOC..."
    },
    {
      "action": "label_added",
      "pr_number": 42,
      "label": "winner"
    }
  ],

  "statistics": {
    "average_score": 68.5,
    "median_score": 72,
    "highest_score": 80,
    "lowest_eligible_score": 62,
    "common_issues": [
      "Missing token validation on mount (3/5 submissions)",
      "No test coverage (4/5 submissions)",
      "Inconsistent error handling (2/5 submissions)"
    ],
    "standout_patterns": [
      "Good TypeScript usage across all submissions",
      "Clean separation of context and hook"
    ]
  }
}
```

---

## Execution

```bash
export PROJECT_ID="550e8400-e29b-41d4-a716-446655440000"
export HOMEWORK_ID="660e8400-e29b-41d4-a716-446655440001"
export GITHUB_TOKEN="ghp_xxxx..."

claude --command prompts/pr-evaluator.md \
  --var PROJECT_ID="$PROJECT_ID" \
  --var HOMEWORK_ID="$HOMEWORK_ID" \
  --var GITHUB_TOKEN="$GITHUB_TOKEN" \
  --var API_BASE_URL="http://localhost:3000"
```

---

## Begin Evaluation

**Project ID:** $PROJECT_ID
**Homework ID:** $HOMEWORK_ID

Please evaluate all submissions following the steps above:

1. Fetch homework details and acceptance criteria
2. Find all PRs matching the branch naming pattern
3. Review each PR thoroughly using the scoring rubric
4. Generate detailed feedback comments
5. Select the winner based on scores
6. Post comments and winner announcement to GitHub
7. Output the complete evaluation report

**Important Guidelines:**
- Be constructive in all feedback - students should feel encouraged
- Provide specific file:line references for both praise and improvements
- Explain WHY something is good or needs improvement
- The winner must genuinely be the best submission
- Even low-scoring submissions should receive helpful feedback

Begin your evaluation now.
